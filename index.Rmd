---
title: "Horror Movie Profits"
author: "Gaurav Sharma"
date: "29/08/2020"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      dpi = 180,
                      fig.width = 8,
                      fig.height = 5)

library(tidyverse)
library(scales)
library(lubridate)
theme_set(theme_light())
```

### lets fetch in the data for today's data exploration task
```{r}
ttfile <- tidytuesdayR::tt_load("2018-10-23")
movie_profit_raw <- ttfile$movie_profit

movie_profit <- movie_profit_raw %>%
  select(-X1) %>%
  mutate(release_date = parse_date(release_date, "%m/%d/%Y")) %>%
  filter(release_date < "2018-01-01") %>%
  mutate(distributor = fct_lump(distributor, 6)) %>%
  mutate(profit_ratio = worldwide_gross/production_budget,
         Decade = 10 * floor(year(release_date)/10)) %>% 
  drop_na() %>% 
  filter(worldwide_gross > 0) %>% 
  select(release_date, Decade, movie, production_budget:worldwide_gross,profit_ratio, genre, everything())
```

### Lets have a look at the distribution of production budget
```{r}
movie_profit %>% 
    ggplot(aes(production_budget)) +
    geom_histogram() +
    scale_x_log10(labels = dollar_format())

```

### How many distributirs are there
```{r}
movie_profit %>% 
    count(distributor, sort = T)
```

### How do big production houses spend in erms of production buudget. Lets see
```{r}
movie_profit %>%
  mutate(distributor = fct_reorder(distributor, -production_budget)) %>% 
  ggplot(aes(distributor, production_budget)) +
  geom_boxplot(fill = "purple",
               alpha = 0.9,
               color = "gray") +
  scale_y_log10(labels = dollar_format()) +
  coord_flip()

```

```{r distributor by various categories}
movie_profit %>% 
    pivot_longer(3:5, "category", "value") %>% 
    ggplot(aes(distributor, value)) +
    geom_boxplot(fill = "purple", alpha = 0.9, color = "gray") +
    scale_y_log10(labels = dollar_format()) +
    coord_flip() +
    facet_wrap(~category, nrow = 3)

```

```{r genre by production udget}
movie_profit %>%
  mutate(genre = fct_reorder(genre, -production_budget)) %>% 
  ggplot(aes(genre, production_budget)) +
  geom_boxplot(fill = "purple",
               alpha = 0.9,
               color = "gray") +
  scale_y_log10(labels = dollar_format()) +
  coord_flip()
  
```

```{r genre by various categories}
movie_profit %>% 
    pivot_longer(3:5, "category", "value") %>% 
    ggplot(aes(genre, value)) +
    geom_boxplot(fill = "pink", color = "gray") +
    scale_y_log10(labels = dollar_format()) +
    coord_flip() +
    facet_wrap(~category, nrow = 3)
```

### What are typical budgets over time (Over years)
```{r}
movie_profit %>% 
  mutate(Year = year(release_date)) %>% 
  ggplot(aes(Year, production_budget, fill = distributor)) +
  geom_col() +
  facet_wrap(~distributor) +
  theme(legend.position = "none")
```

### What are typical budgets over time (Over decades)
```{r}
movie_profit %>% 
  group_by(Decade) %>% 
  summarise_at(vars(production_budget:worldwide_gross), median, na.rm = T) %>% 
  pivot_longer(-Decade, "metric", "value") %>% 
  ggplot(aes(Decade, value, color = metric)) +
  geom_line(size = 1.5) +
  scale_y_log10(labels = dollar_format())
```

```{r}
movie_profit %>% 
  mutate(profit_ratio = worldwide_gross/production_budget) %>% 
  ggplot(aes(profit_ratio)) +
  geom_histogram() +
  scale_x_log10(labels = scales::ordinal_format())
```

```{r}
movie_profit %>% 
  mutate(profit_ratio = worldwide_gross/production_budget,
         genre = fct_reorder(genre, profit_ratio)) %>% 
  ggplot(aes(genre, profit_ratio)) +
  geom_boxplot() +
  scale_y_log10(labels = ordinal_format()) +
  coord_flip()

```

```{r}
movie_profit %>% 
  group_by(genre) %>% 
  summarise(median_profit_ratio = median(profit_ratio)) %>% 
  arrange(desc(median_profit_ratio)) %>% 
  mutate(genre = fct_reorder(genre, median_profit_ratio)) %>% 
  ggplot(aes(genre, median_profit_ratio)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = function(x) paste0(x,"X"))

```

```{r}
movie_profit %>% 
  filter(release_date > "2000-01-01") %>% 
  mutate(year = year(release_date)) %>% 
  group_by(genre, year) %>% 
  summarise(median_profit_ratio = median(profit_ratio),
            movies = n()) %>% 
  ungroup() %>% 
  ggplot(aes(year, median_profit_ratio, color = genre)) +
  geom_line(size = 1) +
  scale_y_continuous(labels = function(x) paste0(x, "X"))
```

Horror movies started being highly profitable around 2012

### What are the most common genres over time?
```{r}
movie_profit %>% 
  count(Decade, genre) %>%
  group_by(Decade) %>% 
  mutate(ratio = n/sum(n)) %>% 
  ggplot(aes(Decade, ratio, color = genre)) +
  geom_line(size = 1) +
  scale_y_continuous(labels = percent_format())
  
```

```{r}
movie_profit %>% 
  ggplot(aes(genre)) +
  geom_bar(aes(fill = genre)) +
  coord_flip() +
  facet_wrap(~ distributor, scales = "free_x") +
  theme(legend.position = "none")
```

```{r}

```









